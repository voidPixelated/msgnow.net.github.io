<style>
  .message {
    display: flex;
    align-items: flex-start;
    margin-bottom: 12px;
    padding: 8px 12px;
    border-radius: 10px;
    max-width: 100%;
    word-break: break-word;
    opacity: 0;
    transform: translateY(10px);
    transition: opacity 0.3s ease, transform 0.3s ease;
  }
  .message.show {
    opacity: 1;
    transform: translateY(0);
  }
</style>

<script>
  async function fetchMessages() {
    try {
      const res = await fetch(csvUrl);
      const text = await res.text();
      const lines = text.trim().split('\n');

      if (lines.length < 2) return;

      const newFeed = document.createDocumentFragment(); // temp container
      for (let i = 1; i < lines.length; i++) {
        const cols = lines[i].split(',');
        const timestamp = cols[0] || '';
        const username = cols[1] || 'Anonymous';
        const pfpUrl = cols[2] || defaultPFP;
        const msg = cols[3] || '';

        const messageEl = document.createElement('div');
        messageEl.className = 'message';

        const pfpImg = document.createElement('img');
        pfpImg.className = 'pfp';
        pfpImg.src = pfpUrl;
        pfpImg.onerror = () => { pfpImg.src = defaultPFP; };

        const contentDiv = document.createElement('div');
        contentDiv.className = 'content';
        contentDiv.innerHTML =
          `<span class="username">${username}</span>` +
          `<span class="timestamp">${timestamp}</span>` +
          `<span class="text">${msg}</span>`;

        messageEl.appendChild(pfpImg);
        messageEl.appendChild(contentDiv);
        newFeed.appendChild(messageEl);
      }

      // Replace old feed after building new one
      feedDiv.innerHTML = '';
      feedDiv.appendChild(newFeed);

      // Animate messages in
      feedDiv.querySelectorAll('.message').forEach((m, idx) => {
        setTimeout(() => m.classList.add('show'), idx * 50);
      });

      // Scroll to bottom
      feedDiv.scrollTop = feedDiv.scrollHeight;

    } catch (err) {
      console.error(err);
    }
  }
</script>
